// /assets/site.js
// NADIR Institutional Motion — GSAP + ScrollTrigger
// Requirements:
// - Hero pinned background (100vh)
// - H1 scrubs: slight scale up + fade out as user scrolls
// - Version tag remains anchored (no animation required)
// - Narrative sections pin + scrub: section becomes the “reading frame”
// - No bouncy motion. No large y-transforms for headings.
// - Hover/scroll should feel heavy and deliberate.

gsap.registerPlugin(ScrollTrigger);

(function initNadirMotion() {
  // Respect reduced motion
  const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  if (reduce) return;

  // HERO: pin background; scrub H1 + lead
  const hero = document.querySelector(".nadir-hero");
  if (hero) {
    const h1 = hero.querySelector(".hero-h1");
    const lead = hero.querySelector(".hero-lead");
    const pinBg = hero.querySelector(".hero-pin");

    // Pin the background surface for a cinematic “fixed” feel
    if (pinBg) {
      ScrollTrigger.create({
        trigger: hero,
        start: "top top",
        end: "bottom top",
        pin: pinBg,
        pinSpacing: false
      });
    }

    // Scrub the headline out. Minimal transforms (no big y-shifts).
    if (h1) {
      gsap.fromTo(
        h1,
        { opacity: 1, scale: 1 },
        {
          opacity: 0,
          scale: 1.04,
          ease: "none",
          scrollTrigger: {
            trigger: hero,
            start: "top top",
            end: "bottom top",
            scrub: 1
          }
        }
      );
    }

    if (lead) {
      gsap.fromTo(
        lead,
        { opacity: 1 },
        {
          opacity: 0,
          ease: "none",
          scrollTrigger: {
            trigger: hero,
            start: "top+=80 top",
            end: "bottom top",
            scrub: 1
          }
        }
      );
    }
  }

  // REVEAL blocks: subtle fade only (no motion)
  gsap.utils.toArray(".reveal").forEach((el) => {
    gsap.fromTo(
      el,
      { opacity: 0 },
      {
        opacity: 1,
        duration: 0.9,
        ease: "power1.out",
        scrollTrigger: {
          trigger: el,
          start: "top 85%",
          toggleActions: "play none none reverse"
        }
      }
    );
  });

  // NARRATIVE SECTIONS: pin each section; scrub the focal heading color/opacity
  gsap.utils.toArray(".narrative-section").forEach((section) => {
    const focus = section.querySelector(".scroll-text");
    if (!focus) return;

    // Pin the section to create a “reading frame”
    ScrollTrigger.create({
      trigger: section,
      start: "top top",
      end: "+=900",
      pin: true,
      pinSpacing: true
    });

    // Scrub the focus heading: slight emphasis + color shift
    gsap.fromTo(
      focus,
      { opacity: 0.55, color: "#475569" }, // slateblue
      {
        opacity: 1,
        color: "#0A0F1E", // obsidian
        ease: "none",
        scrollTrigger: {
          trigger: section,
          start: "top top",
          end: "+=450",
          scrub: 1
        }
      }
    );

    // Fade it out near the end so it “disappears” as you continue
    gsap.to(focus, {
      opacity: 0.25,
      ease: "none",
      scrollTrigger: {
        trigger: section,
        start: "+=450 top",
        end: "+=900 top",
        scrub: 1
      }
    });
  });

  // Optional: Copy-to-clipboard for elements that include data-copy attr
  document.querySelectorAll("[data-copy]").forEach((el) => {
    el.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(el.getAttribute("data-copy") || "");
      } catch (_) {}
    });
  });
})();
